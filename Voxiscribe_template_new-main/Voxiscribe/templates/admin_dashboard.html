{% extends 'layout.html' %}
{% block title %}Admin Dashboard - Voxiscribe{% endblock %}
{% block content %}
<div class="dashboard-header">
  <h2>Exam Management</h2>
  <div>
    <a href="{{ url_for('create_exam') }}" class="btn btn-primary">Create Exam</a>
    <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
  </div>
</div>

<div class="card">
  <h3>Your Exams</h3>
  <table class="table">
    <thead>
      <tr>
        <th>Title</th>
        <th>Duration</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="exams-tbody">
      {% for e in exams %}
      <tr data-exam-id="{{ e.id }}">
        <td>{{ e.title }}</td>
        <td>{{ e.duration }} min</td>
        <td class="status">{% if e.published %}Published{% else %}Draft{% endif %}</td>
        <td class="actions">
          {% if not e.published %}
          <button class="btn btn-secondary action-publish">Publish</button>
          {% else %}
          <button class="btn btn-secondary" disabled>Published ✅</button>
          {% endif %}
          <button class="btn btn-danger action-delete">Delete</button>
          <button class="btn btn-info action-view-attempts">View Attempts</button>
          <a class="btn btn-info" href="{{ url_for('download_results', exam_id=e.id) }}">Download CSV</a>
          <a class="btn btn-primary" href="{{ url_for('evaluate_exam', exam_id=e.id) }}">Evaluate</a>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="4">No exams yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Attempts Modal -->
<div id="attempts-modal" class="modal" style="display:none;">
  <div class="modal-content card">
    <span id="attempts-close" class="modal-close">&times;</span>
    <h3>Exam Attempts</h3>
    <div id="attempts-body">Loading...</div>
  </div>
</div>

<script>
(function(){
  const tbody = document.getElementById('exams-tbody');
  if (!tbody) return;

  tbody.addEventListener('click', async function(e){
    const tr = e.target.closest('tr');
    if (!tr) return;
    const examId = tr.getAttribute('data-exam-id');

    if (e.target.classList.contains('action-publish')) {
      const res = await fetch(`/publish_exam/${examId}`, { method: 'POST' });
      const data = await res.json();
      if (data.success) {
        tr.querySelector('.status').textContent = 'Published';
        e.target.outerHTML = '<button class="btn btn-secondary" disabled>Published ✅</button>';
        showToast('Exam published');
      } else {
        showToast('Failed to publish', true);
      }
    }

    if (e.target.classList.contains('action-delete')) {
      if (!confirm('Are you sure you want to delete this exam?')) return;
      const res = await fetch(`/delete_exam/${examId}`, { method: 'DELETE' });
      const data = await res.json();
      if (data.success) {
        tr.remove();
        showToast('Exam deleted');
      } else {
        showToast('Delete failed: ' + (data.message||'error'), true);
      }
    }

    if (e.target.classList.contains('action-view-attempts')) {
      openAttemptsModal(examId);
    }
  });

  function openAttemptsModal(examId){
    const modal = document.getElementById('attempts-modal');
    const body = document.getElementById('attempts-body');
    modal.style.display = 'block';
    body.textContent = 'Loading...';
    fetch(`/view_attempts/${examId}`).then(r=>r.json()).then(d=>{
      if (!d.success) { body.textContent = 'Failed to load attempts'; return; }
      if (!d.attempts || d.attempts.length===0) { body.textContent = 'No attempts yet.'; return; }
      const html = [`<table class="table"><tr><th>Student</th><th>Status</th><th>Total</th><th>Started</th><th>Submitted</th></tr>`];
      d.attempts.forEach(a=>{
        html.push(`<tr><td>${a.username}</td><td>${a.status}</td><td>${a.total_score??''}</td><td>${a.started_at??''}</td><td>${a.submitted_at??''}</td></tr>`);
      });
      html.push('</table>');
      body.innerHTML = html.join('');
    }).catch(()=>{ body.textContent = 'Error loading attempts'; });
  }

  document.getElementById('attempts-close').onclick = function(){
    document.getElementById('attempts-modal').style.display = 'none';
  };

  function showToast(msg, isError){
    const t = document.createElement('div');
    t.className = 'toast' + (isError?' toast-error':'');
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(()=>{ t.classList.add('show'); }, 10);
    setTimeout(()=>{ t.classList.remove('show'); t.remove(); }, 3000);
  }
})();
</script>
{% endblock %}